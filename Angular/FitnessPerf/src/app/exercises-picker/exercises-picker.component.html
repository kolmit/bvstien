<app-header [parentModel]="model"></app-header>
<div class="flex-column workout-title">
    <h1 class="flex-row workout-manage">
        <span>{{this.myWorkout | titlecase}}</span>
    </h1>
    <div class="flex-row">
        <button mat-raised-button style="padding: 0 1rem; margin-top: -2rem;" (click)="openSessionHistory()" *ngIf="this.allSessions.length > 0">
            Mes dernières séances
        </button>
    </div>
</div>

<hr class="separator" style="margin-bottom: 0;">

<mat-accordion multi>
    <div class="flex-column">
        <div class="flex-row session-add-del">
            <span class="add-del del-btn" (click)="deleteCurrentSession()">{{CONSTANTS.CROSS_MARK}}</span>
            <div class="flex-row date-container" style="width: 65%;">
                <div class="add-del" (click)="switchSession(-1)" (disabled)="isSessionIndexExisting(-1)" [style.opacity]="isSessionIndexExisting(-1) ? 1 : 0.2"> &#10094; </div>
                <div class="flex-column session-date">
                    <div class="flex-column workout-date" *ngIf="this.allSessions[this.currentSessionIndex]; else noSessionToday"> 
                        <span class="session-duno">Séance du {{this.allSessions[this.currentSessionIndex]?.timestamp | date:'dd MMM. yyyy'}}</span>
                    </div>
                    <ng-template #noSessionToday>Pas de séance</ng-template>
                </div>
                <div class="add-del" (click)="switchSession(1)" (disabled)="isSessionIndexExisting(1)" [style.opacity]="isSessionIndexExisting(1) ? 1 : 0.2"> &#10095; </div>
            </div>
            <span class="add-del add-btn" (click)="pickSessionDate()">{{CONSTANTS.PLUS_MARK}}</span>
        </div>
        <div class="recap-btn-container">
            <button mat-raised-button class="recap-btn" (click)="this.recapToggled = !this.recapToggled">
                Synthèse
                <span *ngIf="recapToggled" class="default-program-check">✔</span>
            </button>
        </div>
    </div>
    <ng-container *ngIf="recapToggled">
        <app-session-details [session]="this.allSessions[this.currentSessionIndex]"></app-session-details>
    </ng-container>
    <div *ngIf="this.allSessions[this.currentSessionIndex] && !recapToggled">
        <form [formGroup]="workoutForm" class="exercises-container flex-column">

            <div formArrayName="exercisesForms">
                <!-- NgFor sur les exercices : -->
                <div *ngFor="let exercice of getExerciseForms().controls; let exerciceIndex=index">
                    <mat-expansion-panel [expanded]="getExerciseSeries(exerciceIndex).length > 1" hideToggle>
                        <mat-expansion-panel-header>
                            <mat-panel-title>
                                {{this.allSessions[this.currentSessionIndex].workout.exercises[exerciceIndex]?.name}}
                            </mat-panel-title>
                            <span class="delete-exo-button" 
                                (click)="deleteExercise(this.allSessions[this.currentSessionIndex].workout.exercises[exerciceIndex].name)"> 
                                {{CONSTANTS.CROSS_MARK}} 
                            </span>
                        </mat-expansion-panel-header>
                        
                        <div [formGroupName]="exerciceIndex">
                            <div formArrayName="serieForm">
                                <!-- Les champs de la série -->
                                <div *ngFor="let champsSerie of getExerciseSeries(exerciceIndex).controls; let serieIndex=index">
                                    <div [formGroupName]="serieIndex"  class="flex-row exercise-set">

                                        <mat-form-field [floatLabel]="floatLabelControl.value">
                                            <mat-label>Répétitions</mat-label>
                                            <input type="number" 
                                                [ngStyle]="{'opacity': isPrefilled(exerciceIndex, serieIndex) ? '0.5' : '1' }" 
                                                matInput
                                                formControlName="repetitionCtrl"
                                            >
                                        </mat-form-field>
                                        
                                        <mat-form-field [floatLabel]="floatLabelControl.value">
                                            <input type="number" 
                                                [ngStyle]="{'opacity': isPrefilled(exerciceIndex, serieIndex) ? '0.5' : '1' }" 
                                                matInput placeholder="Charge" 
                                                formControlName="weightCtrl"
                                            >
                                        </mat-form-field>
                                        
                                        <button mat-mini-fab 
                                                class="submit-exercise-set" 
                                                *ngIf="!isSerieEmpty(exerciceIndex, serieIndex)" 
                                                (click)="submitSerie(exerciceIndex, serieIndex)" >
                                                {{CONSTANTS.CHECK_MARK}}
                                        </button>
                                        <button mat-mini-fab 
                                                class="delete-exercise-set" 
                                                *ngIf="!isSerieEmpty(exerciceIndex, serieIndex) && !isPrefilled(exerciceIndex, serieIndex)" 
                                                (click)="deleteSerie(exerciceIndex, serieIndex)" >
                                                {{CONSTANTS.CROSS_MARK}}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </mat-expansion-panel>
                </div>
            </div>
        </form>
        <textarea
            class="session-commentary" 
            placeholder="Commentaire sur la séance" 
            cols="30" rows="3" 
            [(ngModel)]="sessionCommentary" 
            (ngModelChange)="textaeraChanged($event)">
        </textarea>
    </div>
</mat-accordion>

<div *ngIf="this.allSessions[this.currentSessionIndex] && !recapToggled" class="flex-row">
    <button mat-mini-fab class="add-button" (click)="addExercise()">+</button>
</div>

